---
title: "Krill SDMs figures"
author: "Solene Derville"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
output: 
   html_document:
    highlight: pygments
    keep_md: false
    number_sections: true
    toc: true
    toc_float:
      collapsed: false
---

### File paths
```{r, echo=F, result="hide", include=F}
# install.packages("maptools", repos = "https://packagemanager.posit.co/cran/2023-10-13")

lib=lapply(c("plyr","officer","raster","sf", "viridis", "ggthemes", "patchwork", 
             "tidyverse", "lubridate", "mgcv", "gratia", "ape", "gstat", "RColorBrewer", "png", "gridExtra", "grid", "scales", "fmsb", "stars"), library, character.only=T)

mon_theme <- theme(
        panel.border = element_rect(linewidth=0.5, color="black", fill="transparent"),
        plot.margin=unit(c(2,2,2,2),"mm"),
        panel.background = element_rect(fill = 'white'),
        text=element_text(size=8),
        title = element_text(size=rel(1)))

krillsp_col <- data.frame(group = c("EPAC", "TSPIN"),
                          col = c("#e1c340", "#4cd7d0"))
krillsp_pal <- c("#e1c340",  "#4cd7d0")
krillsp_pal_dark <- c("#B7970F", "#208F89")
krillsp_pal_light <- c("#FBF3D2", "#DAF4F3")
```

Environmental data for maps
```{r, warning = F, message = F}
# coastline shapefile
coast_sf <- st_read("../Data/Environment/coast_openstreetmap_WA-OR-CA.shp")
coast_sf_utm <- st_transform(coast_sf, crs = 32610)

# isobaths
iso_sf <- st_read("../Data/Environment/isobaths_50mto1500m.shp")
iso_sf_utm <- st_transform(iso_sf, crs = 32610)

# isobath 1500 m
iso_sf1500 <- st_read("../Data/Environment/iso_sf1500.shp")

# Habitat shapefiles
load("../Data/Environment/zones_split.RData")

# Places names
places <- data.frame(name = c("La Push", "Columbia River", "Newport", "Crescent City", "Cape Blanco", "Cape Mendocino", "Point Arena"),
                      lon = c(-124.7, -123.8, -124.1,-124, -124.3, -124.07, -123.6),
                      lat = c(47.95, 46.4, 44.65, 41.77, 42.83, 40.445, 38.937)) 
places <- st_as_sf(places, coords = c("lon", "lat"), crs = 4326) %>% 
  st_transform(crs = 32610)

# us west coast states limits
states <- st_read("../Data/Environment/west_coast_states.shp", crs = 4326)
states_name <- data.frame(label = c("WA", "OR", "CA"), 
    x = rep(-123.6, 3), 
    y = c(47.5, 44, 41.5)) %>% 
  st_as_sf(coords = c("x", "y"), crs = 4236) %>% 
  st_transform(crs = 32610)

# make a raster of cells that should be turned to NA (inland waters etc.)
NAcells <- read_sf("../Data/Environment/coast_simplified_WA-OR-CA.shp") %>% 
  st_set_crs(4326) %>% 
  st_transform(crs = 32610)
```

Krill data
```{r}
load("../1-Krill_aggregate/Outputs/krill_df.RData")
load("../3-NASC_models/Outputs/krill_day_df.RData")
load("../4-Biomass_models/Outputs/biomass_df.RData")
load("../4-Biomass_models/Outputs/biomass_nhl_df.RData")
```

Model outputs
```{r}
# krill NASC SDM
load("../3-NASC_models/Outputs/ENScurves_krill_dynlogdep.RData")
load("../3-NASC_models/Outputs/influ_gam_dynlogdep.RData")
load("../3-NASC_models/Outputs/influ_brt_dynlogdep.RData")
load("../3-NASC_models/Outputs/predyear_crossENSavg_dynlogdep.RData")

# Biomass SDM
load("../4-Biomass_models/Outputs/ENScurves_krillmass_topolog.RData")
load("../4-Biomass_models/Outputs/influ_brt_topolog_mass.RData")
load("../4-Biomass_models/Outputs/influ_gam_topolog_mass.RData")
load("../4-Biomass_models/Outputs/predyear_crossENSavg_topolog_mass.RData")
load("../4-Biomass_models/Outputs/all_biomass_eval_df.RData")

# final predictions
load("../4-Biomass_models/Outputs/pred_nascXmass_ENSENStopolog.RData")
load("../4-Biomass_models/Outputs/krill_final_ENSxENStopolog_trend.RData")
load("../4-Biomass_models/Outputs/krill_nhl_pred_ENSENStopolog_trend.RData")
```

Some basic numbers
```{r}
nrow(biomass_df)
nrow(biomass_nhl_df)
nrow(krill_day_df)

summary(krill_day_df$nasc)
median(krill_day_df$nasc)

summary(biomass_df$mass_EPAC)

summary(biomass_df$mass_TSPIN)

wilcox.test(x = biomass_df$mass_EPAC, y =biomass_df$mass_TSPIN)

# length of acoustic track data in meters
krill_track_day <- krill_df %>% 
  filter(phase == "day")
# data in 10 m horizontal bins
nrow(krill_track_day) * 10

# data by season by year
krill_day_df %>% 
  group_by(CruiseID) %>% 
  summarize(nb_days = n_distinct(Date_M))

biomass_df %>% 
  group_by(CruiseID) %>% 
  summarize(nb_samples = n_distinct(Sample.Code))

```


# Figure 1

```{r}
# US small map
northam <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf", continent = "North America") %>% 
  filter(admin %in% c("United States of America", "Canada", "Mexico"))

# oregon
orcawa <- maps::map("state", plot = F, fill = TRUE) %>% 
  st_as_sf() %>% 
  filter(ID %in% c("oregon", "california", "washington"))

g <- ggplot(northam) +
  geom_sf(fill = "grey95", col = "grey30", lwd = 0.1) +
  geom_sf(data = orcawa, fill = "grey50", col = "grey30", lwd = 0.1) +
  coord_sf(xlim = c(-170, -68), ylim=c(20, 72)) +
  theme_void() +
  theme(panel.border = element_rect(color = "grey10", fill = "transparent", linewidth = 1))
ggsave(g, file = "./Outputs/inset_fig.png", bg = "transparent", units = "mm", width = 50, height = 40, dpi = 800)
```


```{r, fig.width = 12}
places_fig1 <- data.frame(name = c("La Push", "Columbia River", "Newport (NH Line)", "Crescent City", "Cape Blanco", "Cape Mendocino", "Point Arena"),
                      lon = c(-124.7, -123.8, -123.8, -124, -124.3, -124.07, -123.6),
                      lat = c(47.95, 46.4, 44.65, 41.77, 42.83, 40.445, 38.937)) 
places_fig1 <- st_as_sf(places_fig1, coords = c("lon", "lat"), crs = 4326) %>% 
  st_transform(crs = 32610)

base <- biomass_df %>% 
  st_as_sf(coords = c("utmx", "utmy"), crs = 32610) %>% 
  ggplot() +
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey80", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50")

north_america <- readPNG("./Outputs/inset_fig.png", TRUE)
  
g1 <- base +
    geom_tile(data = krill_day_df, aes(utmx, utmy, fill = log(nasc + 0.01)),
              width = 5e3, height = 5e3, alpha = 0.8) +
    scale_fill_viridis(na.value = "transparent", # scale_fill_gradient(low = "grey90", high = "grey5"
                         name = "Total Krill NASC",
                        breaks = log(c(0.01, 10, 10000)), 
                        labels = c(0, 10, 10000)) +
    ggsn::scalebar(iso_sf_utm, dist = 100, dist_unit = "km", location = "bottomleft", 
                   transform = F, anchor = c(x = 68000, y = 4250000), st.size = 2, 
                   st.dist = 0.01, border.size = 0.1, height = 0.01) +
    annotation_custom(
      rasterGrob(north_america),
      xmin = 40000, xmax = 40000+251907,
      ymin = 4300000, ymax = 4300000+201526) +
    geom_sf_text(data = places_fig1, 
                        aes(label = name), nudge_x = 5e4, size = 1.5, col = "grey90")

g2 <- base +
    geom_sf(aes(fill = log(mass_EPAC + 0.1), size = mass_EPAC), alpha = 0.6, shape = 21) +
    scale_fill_viridis(na.value = "transparent", 
                         name = expression(paste(italic("E. pacifica"), " Biomass (mg/", m^{3}, ")", sep = "")),
                         breaks = log(c(0.1, floor(max(biomass_df$mass_EPAC)))), 
                         labels = c(0, floor(max(biomass_df$mass_EPAC))))

g3 <- base +
    geom_sf(aes(fill = log(mass_TSPIN + 0.1), size = mass_TSPIN), alpha = 0.6, shape = 21) +
    scale_fill_viridis(na.value = "transparent",
                         name = expression(paste(italic("T. spinifera"), " Biomass (mg/", m^{3}, ")", sep = "")),
                        breaks = log(c(0.1, floor(max(biomass_df$mass_TSPIN)))), 
                        labels = c(0, floor(max(biomass_df$mass_TSPIN))))

g <- ( g1 | g2 | g3) &
    geom_sf(data = states, fill = NA, color = "grey90", size = 0.1) &
    geom_sf_text(data = states_name, aes(label = label), col = "white", size = 3) &
    plot_annotation(tag_level = "a") &
    coord_sf(xlim = c(-30592.78, 561873.5), ylim = c(4150571, 5378175), expand = F) &
    scale_size(guide = "none") &
    mon_theme &
    xlab("") &
    ylab("") &
    theme(axis.text.y = element_text(angle = 90, hjust = 0.5),
          #axis.text.x = element_text(hjust = 0.9),
          legend.key.size = unit(0.6, "lines"),
          #legend.title = element_text(size = 8),
          legend.position = "bottom",
          legend.box="horizontal",
          panel.spacing = unit(0.1, "lines"),
          plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")) &
    guides(fill = guide_colorbar(title.position="top", title.hjust = 0.5))

ggsave(g, file = "./Outputs/figure1b.png", width = 190, height = 150, dpi = 500, units = "mm")
g
```

# Figure 2


```{r}
# calculate influence of predictors in the BRT bin and the GAM abundance models
influ_brt_plot <- influ_brt_dynlogdep %>% 
  filter(family == "bin") %>% 
  ddply(., .(family), function(d){
  d <- d %>% 
    ungroup() %>% 
    dplyr::select(-c(method, family, sdInf)) %>% 
    t %>% # transpose columns
    as.data.frame() %>% 
    rownames_to_column()
  names(d) <- d[1,]
  d <- d[-1,]
  d <- d %>% 
    rename("CANYON" = "DIS_CANYON", "BBV" = "bbv_200", 
           "CURL" = "curl", "ILD" = "ild_05", "SSHSD" = "sshsd", 
           "SSH" = "ssh", "SSTSD" = "sstsd", "SST" = "sst", "EKE" = "eke", "DEPTH" = "logDEPTH") %>% 
    select(predvar, DEPTH, CANYON, SLOPE, BBV, ILD, CURL, SST, SSH, SSHSD, SSTSD, EKE)
  # convert back to numeric
  a <- sapply(d[, names(d)[-1]], as.numeric)
  return(a)
})

influ_gam_plot <- influ_gam_dynlogdep %>% 
  filter(family == "lognasc") %>% 
  ddply(., .(family), function(d){
  d <- d %>%  
    dplyr::select(-c(method, family, mean_pvalue)) %>% 
    t %>% # transpose columns
    as.data.frame() %>% 
    rownames_to_column()
  names(d) <- d[1,]
  d <- d[-1,]
  d <- d %>% 
    dplyr::rename(thresh = predvar, "DEPTH" = "s(logDEPTH)", "CANYON" = "s(DIS_CANYON)", 
           "SLOPE" ="s(SLOPE)", "BBV" = "s(bbv_200)", 
           "CURL" = "s(curl)", "ILD" = "s(ild_05)", "SSHSD" = "s(sshsd)", 
           "SSH" = "s(ssh)", "SSTSD" = "s(sstsd)", "SST" = "s(sst)",
           "EKE" = "s(eke)") %>% 
    select(thresh, DEPTH, CANYON, SLOPE, BBV, ILD, CURL, SST, SSH, SSHSD, SSTSD, EKE)
  # convert back to numeric
  a <- sapply(d[, names(d)[-1]], as.numeric)
  d <- cbind(d["thresh"], as.data.frame(a))
  return(d)
})

png("./Outputs/figure2a.png", res = 600, units = "mm", width = 190, height = 80)
op <- par(mar = c(0.2, 0.2, 2, 0.2))
par(mfrow = c(1,2))
d <- influ_brt_plot %>%
  dplyr::select(-c(family)) %>% 
  dplyr::arrange(desc(row_number()))
d <- rbind(rep(20, ncol(d)) , rep(0, ncol(d)) , d)
radarchart(d, seg = 4, axistype=1, 
             pcol = "grey5", 
             plwd=1.5,  plty=1, cglcol="grey", cglty=1,
             axislabcol="grey25", cglwd=0.8, vlcex=0.5,
             pfcol = scales::alpha("grey5", 0.7),
             caxislabels = seq(0, 20, 5),
             palcex = 0.5,
           calcex = 0.5,
          title = "Presence/absence model")

d <- influ_gam_plot %>%
  column_to_rownames("thresh") %>% 
  dplyr::select(-c(family)) %>% 
  dplyr::arrange(desc(row_number()))
d <- rbind(rep(8, ncol(d)) , rep(0, ncol(d)) , d)
radarchart(d, seg = 5, axistype=1, 
             pcol = "grey50", 
             plwd=1.5,  plty=1, cglcol="grey", cglty=1,
             axislabcol="grey50", cglwd=0.8, vlcex=0.5,
             pfcol = scales::alpha("grey50", 0.4),
             caxislabels = c(0, 2, 4, 6, 8, ""),
             palcex = 0.5,
          calcex = 0.5,
          title = "Abundance model")
dev.off()


g2apng <- readPNG("./Outputs/figure2a.png", TRUE)
g2a <- ggplot() +
  scale_y_continuous(limits = c(0, 4), expand = c(0,0)) +
  scale_x_continuous(limits = c(0, 10), expand = c(0,0)) +
  annotation_custom(
      rasterGrob(g2apng),
      ymin = 0, ymax = 4,
      xmin = 0, xmax = 10) +
  theme_void() +
  theme(text=element_text(face="bold", size=8), #general size for all text.looks small here but ok once using ggsave with 600 dpi and default pointsize
        title = element_text(size=rel(1)), # all titles will be a little larger than labels
  plot.margin=unit(c(0,0,0,0),"mm")) # do not add margins either

g2b1 <- ENScurves_krill_dynlogdep %>% 
  filter(family == "bin") %>% 
  mutate(id = paste(folds, sep = "_"),
         predvar = car::recode(predvar, "'DIS_CANYON' = 'CANYON'; 'bbv_200' = 'BBV'; 
           'curl' = 'CURL'; 'ild_05' = 'ILD'; 'sshsd'='SSHSD'; 
           'ssh' = 'SSH';  'sstsd' = 'SSTSD';'sst' = 'SST'; 'eke' = 'EKE';
           'logDEPTH' = 'DEPTH'", as.numeric = F)) %>% 
  mutate(predvar = factor(predvar, levels = c("DEPTH",  "CANYON", "SLOPE", "BBV", "ILD", "CURL", "SST", "SSH", "SSHSD", "SSTSD", "EKE"))) %>% 
  mutate(x = ifelse(predvar == "DEPTH", exp(x), x),
         x = ifelse(predvar == "EKE", 10^x - 0.01, x)) %>%
  ggplot(aes(x, fit, group = id)) +
      geom_path(linewidth = 0.8, alpha = 0.9, col = "grey5") +
      facet_wrap(~predvar, scales = "free", ncol = 6) +
      ylab("Probability of krill presence") +
      xlab("") +
      mon_theme +
      theme(axis.text.x = element_text(angle = 40, vjust = 0.48),
        legend.key.size = unit(1.0, "lines"),
        legend.position = "bottom",
        strip.background = element_rect(color = "black", fill = "white", linewidth = 0.5, linetype = "solid"))

g2b2 <- ENScurves_krill_dynlogdep %>% 
  filter(family == "lognasc") %>% 
  mutate(id = folds,
         predvar = car::recode(predvar, "'DIS_CANYON' = 'CANYON'; 'bbv_200' = 'BBV'; 
           'curl' = 'CURL'; 'ild_05' = 'ILD'; 'sshsd'='SSHSD'; 
           'ssh' = 'SSH';  'sstsd' = 'SSTSD';'sst' = 'SST'; 'eke' = 'EKE';
           'logDEPTH' = 'DEPTH'", as.numeric = F)) %>% 
  mutate(predvar = factor(predvar, levels = c("DEPTH",  "CANYON", "SLOPE", "BBV", "ILD", "CURL", "SST", "SSH", "SSHSD", "SSTSD", "EKE"))) %>% 
  mutate(x = ifelse(predvar == "DEPTH", exp(x), x),
         x = ifelse(predvar == "EKE", 10^x - 0.01, x)) %>%
  ggplot(aes(x, fit, group = id)) +
      geom_path(linewidth = 0.8, alpha = 0.9, col = "grey50") +
      facet_wrap(~predvar, scales = "free", ncol = 6) + 
      ylab("Krill abundance") +
      xlab("Environmental predictors") +
      mon_theme +
      theme(axis.text.x = element_text(angle = 30, vjust = 0.48),
        legend.key.size = unit(1.0, "lines"),
        legend.position = "bottom",
        strip.background = element_rect(color = "black", fill = "white", linewidth = 0.5, linetype = "solid"))

g2 <- g2a / g2b1 / g2b2 &
  plot_annotation(tag_levels = c('a'))
ggsave(g2, file = "./Outputs/figure2.png", width = 190, height = 210, dpi = 500, units = "mm")
g2
```

# Figure 3

```{r}
# transform into sf format
d3 <- predyear_crossENSavg_dynlogdep %>% 
  filter(substr(pred_months, 7, 7) %in% c("2", "5", "9")) %>% 
  filter(as.numeric(substr(pred_months, 2, 5)) >= 2018)  %>% 
  mutate(pred_df = map(meanpred, function(r){
      # turn raster to sf object
      d <- r %>% 
        st_as_stars() %>%
        st_as_sf(as_points = T, crs = 32610) %>% 
        rename(fit = layer)
      # add coordinates to dataframe of predictions
      d[c("x", "y")] <- st_coordinates(d)
      return(d)
    })) %>% 
    mutate(month = month(as.POSIXct(pred_months, format = "X%Y.%m.%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us"),
           year = year(as.POSIXct(pred_months, format = "X%Y.%m.%d")),
           period = paste(month, year)) %>%  
    dplyr::select(period, month, year, pred_df) %>%
    # arrange and mutate factor levels so that plots show up in the right order by months 
    arrange(year, month) %>% 
    mutate(period = factor(period, levels = unique(period))) %>% 
    unnest(pred_df)

places_onepanel <- places %>% 
  slice(rep(1:n(), each = length(unique(d3$period)))) %>%
  mutate(period = rep(unique(d3$period), times = nrow(places)),
         label = ifelse(period != "Feb 2018", NA, name))

# sf version of the dataframe
d3_sf <- st_as_sf(d3, coords = c("x", "y"), crs = 32610)

# create facetted maps by year in columns and months in rows
g3 <- ggplot() +
    geom_tile(data = d3, aes(x, y, fill = log(fit + 0.1))) +
    scale_fill_viridis_b(na.value = "transparent", 
                         name = "Predicted krill NASC",
                         n.breaks = 6,
                        breaks = log(c(1, 5, 20, 50, 100, 500)), 
                        labels = c("1", "5", "20","50", "100","500")) +  
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey80", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
    geom_sf(data = states, fill = NA, col = "grey30", size = 0.1) +
    facet_wrap(~period, ncol = n_distinct(d3$year), dir = "v") +
    ggsn::scalebar(d3_sf, dist = 100, dist_unit = "km", location = "bottomleft", 
                   transform = F, anchor = c(x = 20000, y = 4300000), st.size = 2, 
                   st.dist = 0.02, st.color = "white", border.size = 0.1, height = 0.02, facet.var = 'period', 
                   facet.lev = 'Sep 2022') +
    coord_sf(xlim = c(-30592.78, 561873.5), ylim = c(4150571, 5378175), expand = F) +
    mon_theme +
    xlab("") +
    ylab("") +
    theme(axis.text.y = element_text(angle = 90, hjust = 0.5),
          axis.text.x = element_text(hjust = 0.9, angle = 30),
          text=element_text(face="bold", size=8),
          legend.key.size = unit(1, "lines"),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom",
          legend.box="horizontal",
          legend.text = element_text(size = 6),
          plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
          strip.background = element_rect(color = "black", fill = "white", linewidth = 0.5, linetype = "solid")) +
    guides(fill = guide_colorbar(barwidth = 20, barheight = 0.5))
  
ggsave(g3, file = "./Outputs/figure3.png", width = 190, height = 260, dpi = 500, units = "mm")
g3
```

# Figure 4
```{r}
influ_brt_plot_mass <- ddply(influ_brt_topolog_mass, .(group, family), function(d){
  d <- d %>% 
    ungroup() %>% 
    dplyr::select(-c(group, method, family, sdInf)) %>% 
    t %>% # transpose columns
    as.data.frame() %>% 
    rownames_to_column()
  names(d) <- d[1,]
  d <- d[-1,]
  d <- d %>% 
    rename("CANYON" = "DIS_CANYON", "DEPTH" = "logDEPTH") %>% 
    select(predvar, DEPTH, CANYON, SLOPE)
  # convert back to numeric
  a <- sapply(d[, names(d)[-1]], as.numeric)
  return(a)
})

influ_gam_plot_mass <- ddply(influ_gam_topolog_mass, .(group, family), function(d){
  d <- d %>%  
    dplyr::select(-c(group, method, family, mean_pvalue)) %>% 
    t %>% # transpose columns
    as.data.frame() %>% 
    rownames_to_column()
  names(d) <- d[1,]
  d <- d[-1,]
  d <- d %>% 
    dplyr::rename(thresh = predvar, "DEPTH" = "s(logDEPTH)", "CANYON" = "s(DIS_CANYON)", 
           "SLOPE" ="s(SLOPE)") %>% 
    select(thresh, DEPTH, CANYON, SLOPE)
  # convert back to numeric
  a <- sapply(d[, names(d)[-1]], as.numeric)
  d <- cbind(d["thresh"], as.data.frame(a))
  return(d)
})

png("./Outputs/figure4a.png", res = 600, units = "mm", width = 60, height = 140)
op <- par(mar = c(0.1, 0.1, 1, 0.1))
par(mfrow = c(4, 1))
for(s in unique(krillsp_col$group)){
  d <- influ_brt_plot_mass %>%
  filter(group == s, family == "bin") %>%
  dplyr::select(-c(group, family)) %>% 
  dplyr::arrange(desc(row_number()))
  d <- rbind(rep(ceiling(max(d[1,])/10)*10, ncol(d)), rep(0, ncol(d)) , d)
  radarchart(d, seg = ceiling(max(d[1,])/10)*10/20, axistype=1, 
             pcol = krillsp_col[krillsp_col$group == s, ]$col, 
             plwd = 1.5,  plty=1, cglcol="grey", cglty=1,
             axislabcol="grey25", cglwd=0.8, vlcex=0.8,
             pfcol = scales::alpha(krillsp_col[krillsp_col$group == s, ]$col, 0.7),
             caxislabels = seq(0, ceiling(max(d[1,])/10)*10, 20),
             palcex = 0.5,
             calcex = 0.5) 
}
for(s in unique(krillsp_col$group)){
  d <- influ_gam_plot_mass %>%
  filter(group == s, family == "logmass") %>% 
  column_to_rownames("thresh") %>% 
  dplyr::select(-c(group, family)) %>% 
  dplyr::arrange(desc(row_number()))
  d <- rbind(rep(10, ncol(d)) , rep(0, ncol(d)) , d)
  radarchart(d, seg = 5, axistype=1, 
             pcol = krillsp_col[krillsp_col$group == s, ]$col, 
             plwd=1.5,  plty=1, cglcol="grey", cglty=1,
             axislabcol="grey25", cglwd=0.8, vlcex=0.8,
             pfcol = scales::alpha(krillsp_col[krillsp_col$group == s, ]$col, 0.4),
             caxislabels = c(0, 2, 4, 6, 8, ''),
             palcex = 0.8)
}
mtext("Biomass model", side = 3, line = -20.5, outer = TRUE, font = 2, cex = 0.7)
mtext("Presence/absence model", side = 3, line = -1, outer = TRUE, font = 2, cex = 0.7)
dev.off()


g4apng <- readPNG("./Outputs/figure4a.png", TRUE)
g4a <- ggplot() +
  scale_y_continuous(limits = c(0, 11.5), expand = c(0,0)) + # 7, 4
  scale_x_continuous(limits = c(0, 5), expand = c(0,0)) +
  annotation_custom(
      rasterGrob(g4apng),
      ymin = 0, ymax = 11.5,
      xmin = 0, xmax = 5) +
  theme_void() +
  theme(text=element_text(face="bold", size=8), #general size for all text.looks small here but ok once using ggsave with 600 dpi and default pointsize
        title = element_text(size=rel(1)), # all titles will be a little larger than labels
  plot.margin=unit(c(0,0,0,0),"mm")) # do not add margins either

g4b <- ENScurves_krillmass_topolog %>% 
  filter(family == "bin") %>% 
  mutate(id = paste(folds, group, sep = "_"),
         predvar = car::recode(predvar, "'DIS_CANYON' = 'CANYON';
           'logDEPTH' = 'DEPTH'", as.numeric = F),
         group = car::recode(group, "'EPAC' = 'Epac'; 'TSPIN' = 'Tspin'", as.numeric = F)) %>% 
  mutate(predvar = factor(predvar, levels = c("DEPTH" , "SLOPE" , "CANYON"))) %>% 
  mutate(x = ifelse(predvar == "DEPTH", exp(x), x)) %>%
  ggplot(aes(x, fit, group = id, col = group)) +
      geom_path(linewidth = 0.8, alpha = 0.9, show.legend = F) +
      facet_wrap(~predvar, scales = "free", ncol = 3) +
      ylab("Probability of krill presence") +
      xlab("Environmental predictors") +
      mon_theme +
      scale_color_manual(name = "Species", values = krillsp_pal, 
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
      scale_fill_manual(name = "Species", values = krillsp_pal,
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
      theme(legend.key.size = unit(1.0, "lines"),
        legend.position = "bottom",
        strip.background = element_rect(color = "black", fill = "white", linewidth = 0.5, linetype = "solid"))
g4b

g4c <-ENScurves_krillmass_topolog %>% 
  filter(family == "logmass") %>% 
  mutate(id = paste(folds, group, sep = "_"),
         predvar = car::recode(predvar, "'DIS_CANYON' = 'CANYON'; 
           'logDEPTH' = 'DEPTH'", as.numeric = F),
         group = car::recode(group, "'EPAC' = 'Epac'; 'TSPIN' = 'Tspin'", as.numeric = F)) %>% 
  mutate(predvar = factor(predvar, levels = c("DEPTH" , "SLOPE" , "CANYON"))) %>% 
  mutate(x = ifelse(predvar == "DEPTH", exp(x), x)) %>%
  ggplot(aes(x, fit, group = id, col = group)) +
      geom_path(linewidth = 0.8, alpha = 0.9) +
      facet_wrap(~predvar, scales = "free", ncol = 3) +
      ylab("Krill biomass") +
      xlab("Environmental predictors") +
      mon_theme +
      scale_color_manual(name = "Species", values = krillsp_pal, 
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
      scale_fill_manual(name = "Species", values = krillsp_pal,
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
      theme(legend.key.size = unit(1.0, "lines"),
        legend.position = "bottom",
        strip.background = element_rect(color = "black", fill = "white", linewidth = 0.5, linetype = "solid"))
g4c

g4 <- grid.arrange(g4a, g4b, g4c, layout_matrix = matrix(c(1, 1, 2, 3, 2, 3), nrow = 2))
ggsave(g4, file = "./Outputs/figure4.png", width = 180, height = 130, dpi = 300, units = "mm")

## insets of depth zoomed on 0-300 m
g4bdepth <- ENScurves_krillmass_topolog %>% 
  filter(family == "bin") %>% 
  mutate(id = paste(folds, group, sep = "_"),
         predvar = car::recode(predvar, "'DIS_CANYON' = 'CANYON';
           'logDEPTH' = 'DEPTH'", as.numeric = F),
         group = car::recode(group, "'EPAC' = 'Epac'; 'TSPIN' = 'Tspin'", as.numeric = F)) %>% 
  mutate(x = ifelse(predvar == "DEPTH", exp(x), x)) %>%
  filter(predvar == "DEPTH", x <= 300) %>% 
  ggplot(aes(x, fit, group = id, col = group)) +
      geom_path(linewidth = 0.5, alpha = 0.9, show.legend = F) +
      mon_theme +
      scale_color_manual(name = "Species", values = krillsp_pal) +
      scale_fill_manual(name = "Species", values = krillsp_pal) +
      guides(color = "none") +
      theme(axis.title = element_blank())
g4bdepth
ggsave(g4bdepth, file = "./Outputs/figure4b_depth.png", width = 30, height = 30, dpi = 300, units = "mm")

g4cdepth <- ENScurves_krillmass_topolog %>% 
  filter(family == "logmass") %>% 
  mutate(id = paste(folds, group, sep = "_"),
         predvar = car::recode(predvar, "'DIS_CANYON' = 'CANYON'; 
           'logDEPTH' = 'DEPTH'", as.numeric = F),
         group = car::recode(group, "'EPAC' = 'Epac'; 'TSPIN' = 'Tspin'", as.numeric = F)) %>% 
  mutate(x = ifelse(predvar == "DEPTH", exp(x), x)) %>%
  filter(predvar == "DEPTH", x <= 300) %>% 
  ggplot(aes(x, fit, group = id, col = group)) +
      geom_path(linewidth = 0.5, alpha = 0.9) +
      mon_theme +
      scale_color_manual(name = "Species", values = krillsp_pal) +
      scale_fill_manual(name = "Species", values = krillsp_pal) +
      guides(color = "none") +
      theme(axis.title = element_blank())
g4cdepth
ggsave(g4cdepth, file = "./Outputs/figure4c_depth.png", width = 30, height = 30, dpi = 300, units = "mm")

```


# Figure 5

```{r}
# calculate the proportion of EPAC and TSPIN over monthly rasters
pred_propbiomass_ENS <- predyear_crossENSavg_topolog_mass %>% 
  filter(substr(pred_months, 7, 7) %in% c("2", "5", "9")) %>% 
  filter(as.numeric(substr(pred_months, 2, 5)) == 2022) %>% 
  ddply(., ~pred_months, function(d){
    tibble(epac_prop = list(d$meanpred[[1]]/(d$meanpred[[1]] + d$meanpred[[2]])),
    tspin_prop = list(d$meanpred[[2]]/(d$meanpred[[1]] + d$meanpred[[2]])))
})

### TSPIN ################################
d_tspinprop <- pred_propbiomass_ENS %>%
  mutate(meanpred = tspin_prop) %>% 
  mutate(pred_df = map(meanpred, function(r){
      # turn raster to sf object
      d <- r %>% 
        st_as_stars() %>%
        st_as_sf(as_points = T, crs = 32610) %>% 
        rename(fit = layer)
      # add coordinates to dataframe of predictions
      d[c("x", "y")] <- st_coordinates(d)
      return(d)
    })) %>% 
    mutate(month = month(as.POSIXct(pred_months, format = "X%Y.%m.%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us"),
           year = year(as.POSIXct(pred_months, format = "X%Y.%m.%d")),
           period = paste(month, year)) %>%  
    dplyr::select(period, month, year, pred_df) %>%
    # arrange and mutate factor levels so that plots show up in the right order by months 
    arrange(year, month) %>% 
    mutate(period = factor(period, levels = unique(period))) %>% 
    unnest(pred_df)

summary(d_tspinprop$fit)
  
g5a <- ggplot() +
    geom_tile(data = subset(d_tspinprop, period == "Feb 2022"), aes(x, y, fill = fit*100), show.legend = F) +
    geom_sf(data = NAcells, fill = "white", color = "transparent") +
    scale_fill_viridis_b(na.value = "transparent", 
                         n.breaks = 6, limits = c(0, 100)) +  
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey80", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
    geom_sf(data = states, fill = NA, col = "grey30", size = 0.1) +
    coord_sf(xlim = c(250000, 550000), ylim = c(4150571, 5360000), expand = F) +
    ggtitle(expression(italic("T. spinifera")))

### EPAC ################################
d_epacprop <- pred_propbiomass_ENS %>%
  mutate(meanpred = epac_prop) %>% 
  mutate(pred_df = map(meanpred, function(r){
      # turn raster to sf object
      d <- r %>% 
        st_as_stars() %>%
        st_as_sf(as_points = T, crs = 32610) %>% 
        rename(fit = layer)
      # add coordinates to dataframe of predictions
      d[c("x", "y")] <- st_coordinates(d)
      return(d)
    })) %>% 
    mutate(month = month(as.POSIXct(pred_months, format = "X%Y.%m.%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us"),
           year = year(as.POSIXct(pred_months, format = "X%Y.%m.%d")),
           period = paste(month, year)) %>%  
    dplyr::select(period, month, year, pred_df) %>%
    # arrange and mutate factor levels so that plots show up in the right order by months 
    arrange(year, month) %>% 
    mutate(period = factor(period, levels = unique(period))) %>% 
    unnest(pred_df)

summary(d_epacprop$fit)

g5b <- ggplot() +
    geom_tile(data = subset(d_epacprop, period == "Feb 2022"), aes(x, y, fill = fit*100)) +
    geom_sf(data = NAcells, fill = "white", color = "transparent") +
    scale_fill_viridis_b(na.value = "transparent",
                         name = "Predicted \nProportion (%)",
                         n.breaks = 6, limits = c(0, 100)) +  
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey80", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
    geom_sf(data = states, fill = NA, col = "grey30", size = 0.1) +
    coord_sf(xlim = c(250000, 550000), ylim = c(4150571, 5360000), expand = F) +
    ggtitle(expression(italic("E. pacifica")))

### Combine panels ########################
g5 <- g5a + g5b &
    geom_sf_text(data = places, 
                        aes(label = name), nudge_x = 5e4, size = 2, col = "grey90") &
  plot_layout(guides = "collect") &
  plot_annotation(tag_levels = "a") &
  mon_theme &
  xlab("") &
  ylab("") &
  theme(text =element_text(size=8),
        legend.title =element_text(face="bold", size=8),
        axis.text.y = element_text(angle = 90, hjust = 0.5, size = 5),
        axis.text.x = element_text(hjust = 0.9, size = 5, angle = 30),
        legend.key.size = unit(1, "lines"),
        legend.position = "bottom",
        panel.spacing = unit(0.5, "lines"),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"))

ggsave(g5, file = "./Outputs/figure5.png", width = 110, height = 200, dpi = 300, units = "mm")
g5
```

# Figure 6
```{r, warning = F, fig.height = 20}
pred_nascXmass_ENSENStopolog_tspin <- pred_nascXmass_ENSENStopolog %>% 
    mutate(meanpred = pred_tspin) %>% 
    mutate(month = month(as.POSIXct(pred_months, format = "X%Y.%m.%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us")) %>% 
    ddply(., .(month), function(d){
      out <- mean(stack(d$meanpred), na.rm = T) %>% 
        st_as_stars() %>%
        st_as_sf(as_points = T, crs = 32610) %>% 
        rename(fit = layer)
            # add coordinates to dataframe of predictions
      out[c("x", "y")] <- st_coordinates(out)
      return(out)
    })

pred_nascXmass_ENSENStopolog_epac <- pred_nascXmass_ENSENStopolog %>% 
    mutate(meanpred = pred_epac) %>% 
    mutate(month = month(as.POSIXct(pred_months, format = "X%Y.%m.%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us")) %>% 
    ddply(., .(month), function(d){
      out <- mean(stack(d$meanpred), na.rm = T) %>% 
        st_as_stars() %>%
        st_as_sf(as_points = T, crs = 32610) %>% 
        rename(fit = layer)
            # add coordinates to dataframe of predictions
      out[c("x", "y")] <- st_coordinates(out)
      return(out)
    })

places_onepanel_wholearea <- data.frame(name = c("La Push", "Columbia River", "Newport","Cape Blanco", "Cape Mendocino","Point Arena"),
                      lon = c(-124.7, -125.2, -124.3, -124.5, -125.2, -124.2),
                      lat = c(47.95, 46.35, 44.65, 42.83, 40.445, 38.937)) %>% 
  st_as_sf(., coords = c("lon", "lat"), crs = 4326) %>% 
  st_transform(crs = 32610) %>% 
  slice(rep(1:n(), each = 12)) %>%
  mutate(month = rep(unique(pred_nascXmass_ENSENStopolog_epac$month), times = 6),
         label = ifelse(month != "Jan", NA, name))

mini <- min(c(summary(pred_nascXmass_ENSENStopolog_epac$fit), summary(pred_nascXmass_ENSENStopolog_tspin$fit)))
maxi <- max(c(summary(pred_nascXmass_ENSENStopolog_epac$fit), summary(pred_nascXmass_ENSENStopolog_tspin$fit)))

g6a <- pred_nascXmass_ENSENStopolog_epac %>%
      ggplot() +
      geom_tile(aes(x, y, fill = log(fit + 0.1))) + 
      scale_fill_viridis_b(na.value = "transparent",
                        name = "Predicted species-scaled NASC",
                        breaks = log(c(5, 20, 50, 200, 500, 1000)),
                        labels = c(5, 20, 50, 200, 500, 1000)) +  
      geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey80", linewidth = 0.1) +
      geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
      geom_sf(data = states, fill = NA, col = "grey30", size = 0.1) +
      facet_wrap(~month, ncol = 6, dir = "h") +
      coord_sf(xlim = c(-30592.78, 561873.5), ylim = c(4150571, 5378175), expand = F) +
      ggtitle(expression(italic("E. pacifica"))) +
      guides(fill = guide_colorbar(barwidth = 20, barheight = 0.5))
      

g6b <- pred_nascXmass_ENSENStopolog_tspin %>% 
      ggplot() +
      geom_tile(aes(x, y, fill = log(fit + 0.1))) + 
      scale_fill_viridis_b(na.value = "transparent", 
                         name = "Predicted species-scaled NASC",
                        breaks = log(c(5, 10, 20, 50, 100, 200)),
                        labels = c(5, 10, 20, 50, 100, 200)) +
      geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey80", linewidth = 0.1) +
      geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
      geom_sf(data = states, fill = NA, col = "grey30", size = 0.1) +
      facet_wrap(~month, ncol = 6, dir = "h") +
      coord_sf(xlim = c(-30592.78, 561873.5), ylim = c(4150571, 5378175), expand = F) +
      ggtitle(expression(italic("T. spinifera"))) +
      guides(fill = guide_colorbar(barwidth = 20, barheight = 0.5))


g6 <- g6a / g6b &
    geom_sf_text(data = places_onepanel_wholearea , 
                        aes(label = label), nudge_x = 0, size = 2.2, col = "grey90") &
      plot_annotation(tag_levels = "a") &
      plot_layout(guides = "collect") &
      mon_theme &
      xlab("") &
      ylab("") &
      theme(axis.text.y = element_text(angle = 90, hjust = 0.5),
          axis.text.x = element_text(angle = 40, vjust = 0.48),
          text=element_text(size=8),
          legend.title = element_text(size = 8, face="bold"),
          legend.key.size = unit(0.8, "lines"),
          legend.position = "bottom",
          panel.spacing = unit(0.5, "lines"),
          plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
          strip.background = element_rect(color = "black", fill = "white", linewidth = 0.5, linetype = "solid")) 

ggsave(g6, file = "./Outputs/figure6.png", width = 190, height = 300, dpi = 500, units = "mm")
g6
```


# Figure 7
```{r}
d <- krill_final_ENSxENStopolog_trend %>% 
  group_by(group, month) %>%
  summarize(meansum = mean(sum_abu),
            sdsum = sd(sum_abu)) %>% 
  mutate(group = car::recode(group, "'epac' = 'Epac'; 'tspin' = 'Tspin'", as.numeric = F))

g7 <- ggplot(d, aes(month, meansum, color = group, group = group)) +
    geom_point() +
    geom_errorbar(aes(ymin = meansum - sdsum, ymax = meansum + sdsum, col = group)) +
    geom_path() +
    scale_y_continuous("Species-scaled krill NASC", 
                       breaks = c(0, 5e5, 1.0e6, 1.5e6),
                       labels = c("0", "5.0e5", "1.0e6", "1.5e6")) +
    mon_theme +
    scale_color_manual(name = "Species", values = krillsp_pal, 
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
    scale_fill_manual(name = "Species", values = krillsp_pal,
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
    theme(legend.position = "bottom")
g7
ggsave(g, file = "./Outputs/figure7.png", width = 90, height = 90, dpi = 500, units = "mm")
```

Calculate percent increase between seasons
```{r}
# Compare february to august abundance of both species
d %>% 
  filter(month %in% c("Feb", "Aug")) %>% 
  select(-sdsum) %>% 
  pivot_wider(names_from = "month", values_from = "meansum") %>% 
  mutate(percent_increase = (Aug - Feb)/Feb *100)
```


# Figure 8

Load full time series of NH line
```{r}
#############################
# NHL data from 2001 to 2022
biomass_allnhl_df <- readxl::read_excel("../Data/Biomass/NHL_krill_biomass_2001-2022_sum_LH_w_LatLon.xlsx") %>%
  mutate(time = as.POSIXct(`Sample Date`),
         Year = substr(`Sample Date`, 1, 4)) %>% 
  mutate(Date_M = paste0(substr(as.character(time), 1, 4),
                        substr(as.character(time), 6, 7),
                        substr(as.character(time), 9, 10))) %>% 
  rename(mass_EPAC = `EUPHAUSIA PACIFICA`, mass_TSPIN = `THYSANOESSA SPINIFERA`) %>% 
  mutate(mass_tot = mass_EPAC + mass_TSPIN) %>% 
  filter(Year != "2023") # only two samples in 2023

# number of samples per year
table(biomass_allnhl_df$Year)

# use the 2018-2022 data file to extract depth at each station
depth_stations <- biomass_nhl_df %>% 
  select(Station, DEPTH) %>% 
  distinct()

# join dataframes to add a DEPTH column to the biomass_allnhl_df
biomass_allnhl_df <- biomass_allnhl_df %>% 
  join(., depth_stations, by = "Station")

##### aggregate NHL data by month
bymonthyear_all_nhl_df <- biomass_allnhl_df %>%
  dplyr::select(Station, Year, `Sample Date`, mass_EPAC, mass_TSPIN, mass_tot, DEPTH) %>% 
  pivot_longer(cols = c(mass_EPAC, mass_TSPIN), names_to = "group", values_to = "mass", names_prefix = "mass_") %>% 
  mutate(month = month(as.POSIXct(`Sample Date`, format = "%Y-%m-%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us")) %>% 
  group_by(group, month, Year) %>% # aggregate by month x year to account for uneven sampling (same station sampled multiple times during the same mo)
  summarize(mean1 = mean(mass, na.rm = T))

# the average across years
bymonth_all_nhl_df <- bymonthyear_all_nhl_df %>% 
  group_by(group, month) %>% 
  summarize(mean_obs = mean(mean1, na.rm = T),
            sd_obs = sd(mean1, na.rm = T),
            se_obs = sd(mean1, na.rm = T) / sqrt(n()),
            min_obs = min(mean1, na.rm = T),
            max_obs = max(mean1, na.rm = T)) 

##### aggregate NHL data by depth
bydepthmonthyear_all_nhl_df <- biomass_allnhl_df %>%
  dplyr::select(Station, Year, `Sample Date`, mass_EPAC, mass_TSPIN, mass_tot, DEPTH) %>% 
  pivot_longer(cols = c(mass_EPAC, mass_TSPIN), names_to = "group", values_to = "mass", names_prefix = "mass_") %>% 
  mutate(month = month(as.POSIXct(`Sample Date`, format = "%Y-%m-%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us")) %>% 
  group_by(group, month, Year, DEPTH) %>% # aggregate by month x year x depth
  summarize(mean1 = mean(mass, na.rm = T))

# then aggregate averages by depth
bydepth_all_nhl_df <- bydepthmonthyear_all_nhl_df %>% 
  group_by(group, DEPTH) %>% 
  summarize(mean_obs = mean(mean1 , na.rm = T),
            sd_obs = sd(mean1 , na.rm = T),
            se_obs = sd(mean1, na.rm = T) / sqrt(n()),
            min_obs = min(mean1 , na.rm = T),
            max_obs = max(mean1 , na.rm = T)) 

#############################
# NHL data from 2018 to 2022

##### aggregate NHL data by month
bymonth_18_22_nhl_df <- biomass_nhl_df %>% 
  dplyr::select(Station, Year, Sample.Date, mass_EPAC, mass_TSPIN, mass_tot, DEPTH) %>% 
  pivot_longer(cols = c(mass_EPAC, mass_TSPIN), names_to = "group", values_to = "mass", names_prefix = "mass_") %>% 
  mutate(month = month(as.POSIXct(Sample.Date, format = "%Y-%m-%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us")) %>% 
    group_by(group, month, Year) %>% # aggregate by month x year to account for uneven sampling (same station sampled multiple times during the same mo)
  summarize(mean1 = mean(mass, na.rm = T)) %>% 
  group_by(group, month) %>% 
  summarize(mean_obs = mean(mean1, na.rm = T),
            sd_obs = sd(mean1, na.rm = T),
            se_obs = sd(mean1, na.rm = T) / sqrt(n()),
            min_obs = min(mean1, na.rm = T),
            max_obs = max(mean1, na.rm = T)) 

##### aggregate NHL data by depth
bydepth_18_22_nhl_df <- biomass_nhl_df %>% 
  select(Station, Year, Sample.Date, mass_EPAC, mass_TSPIN, mass_tot, DEPTH) %>% 
  pivot_longer(cols = c(mass_EPAC, mass_TSPIN), names_to = "group", values_to = "mass", names_prefix = "mass_") %>% 
  mutate(month = month(as.POSIXct(`Sample.Date`, format = "%Y-%m-%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us")) %>% 
  group_by(group, month, Year, DEPTH) %>% 
  summarize(mean1 = mean(mass, na.rm = T)) %>% 
  group_by(group, DEPTH) %>% 
  summarize(mean_obs = mean(mean1, na.rm = T),
            sd_obs = sd(mean1, na.rm = T),
            se_obs = sd(mean1, na.rm = T) / sqrt(n()),
            min_obs = min(mean1, na.rm = T),
            max_obs = max(mean1, na.rm = T))
```

Predicted abundance of Epac and Tspin along the NH Line as a function of depth
```{r, message = F, warning = F}
d1 <- krill_nhl_pred_ENSENStopolog_trend %>% 
  filter(DEPTH < -5) %>%  # because the data point closer to shore is NA
  group_by(group, month, year, DEPTH) %>% # average across months within each year
  summarize(mean_pred_acrossmonths = mean(pred, na.rm = T)) %>% 
  group_by(group, DEPTH) %>% # then average by station
  summarize(mean_pred = mean(mean_pred_acrossmonths, na.rm = T),
            sd_pred = sd(mean_pred_acrossmonths, na.rm = T),
            se_pred = sd(mean_pred_acrossmonths, na.rm = T) / sqrt(n()),
            min_pred = min(mean_pred_acrossmonths, na.rm = T),
            max_pred = max(mean_pred_acrossmonths, na.rm = T)) %>%
  arrange(group, DEPTH)

g1 <- ggplot(d1, aes(log(-DEPTH + 1), mean_pred, color = group)) +
    geom_rect(aes(xmin = log(50), xmax = log(260), ymin = 0, ymax = 620), col = "grey95", fill = "grey95") +
    geom_ribbon(aes(fill = group, ymin = mean_pred + se_pred, ymax = mean_pred - se_pred), 
                color = "transparent", alpha = 0.5) +
    geom_path(alpha = 0.9) +
    scale_y_sqrt("Predicted Species-scaled NASC") +
    scale_x_continuous(limits = log(c(10, max(-krill_nhl_pred_ENSENStopolog_trend$DEPTH))),
                       breaks = log(c(10, 50, 100, 200, 500, 1000, 2000)),
                       labels = c(10, 50, 100, 200, 500, 1000, 2000),
                       name = "Seabed depth (m)") +
    scale_color_manual(name = "Species", values = krillsp_pal, 
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
    scale_fill_manual(name = "Species", values = krillsp_pal,
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
    mon_theme

g2 <- g1 +
      scale_x_continuous(limits = log(c(50, 260)),
                       breaks = log(c(50, 75, 100, 200)),
                       labels = c(50, 75, 100, 200),
                       name = "Seabed depth (m)") +
      scale_y_sqrt("Predicted Species-scaled NASC", limits = c(0, 600)) +
      scale_color_manual(name = "Species", values = krillsp_pal, 
                         guide = "none") +
      scale_fill_manual(name = "Species", values = krillsp_pal, 
                        guide = "none") +
    theme(panel.background = element_rect(fill = "grey95"))

g3 <- ggplot(bydepth_all_nhl_df, aes(log(-DEPTH + 1), mean_obs, color = group)) +
    geom_ribbon(aes(fill = group, ymin = mean_obs + se_obs, ymax = mean_obs - se_obs), 
                color = "transparent", alpha = 0.5) +
    geom_path(alpha = 0.9, lty="21", linewidth = 0.5) +
    geom_path(data = bydepth_18_22_nhl_df, 
              aes(log(-DEPTH + 1), mean_obs, group = group, 
                  color = group)) +
    scale_y_sqrt(name = expression(paste("Observed biomass (mg/", m^{3}, ")", sep = ""))) +
    scale_color_manual(name = "Species", values = krillsp_pal, guide = "none") +
    scale_fill_manual(name = "Species", values = krillsp_pal, guide = "none") +
    mon_theme +    
    scale_x_continuous(limits = log(c(50, 260)),
                       breaks = log(c(50, 75, 100, 200)),
                       labels = c(50, 75, 100, 200),
                       name = "Seabed depth (m)") +
    theme(panel.background = element_rect(fill = "grey95"))

g8 <- g1 / (g2 | g3) &
  plot_annotation(tag_levels = "a") &
  plot_layout(guide = "collect") &
  theme(legend.position = "bottom")
g8
ggsave(g8, file = "./Outputs/figure8.png", width = 140, height = 140, dpi = 500, units = "mm")
```

Calculate percent increase between depth ranges and compare between observed and predicted. 
```{r}
####################
### Predicted values

# Rate of decrease along linear trend
d1_lm_in <- d1 %>% 
  filter(DEPTH <= -50, DEPTH >= -260) %>% 
  mutate(mean_pred_standardized = mean_pred/max(mean_pred, na.rm = T)*100)
summary(lm(mean_pred_standardized~log(-DEPTH), d1_lm_in[d1_lm_in$group == "epac",]))
summary(lm(mean_pred_standardized~log(-DEPTH), d1_lm_in[d1_lm_in$group == "tspin",]))

ggplot(d1_lm_in, aes(log(-DEPTH), mean_pred_standardized, col = group)) +
  geom_path()

###################
### Observed values
# Rate of decrease along linear trend
d2_lm_in <- bydepth_all_nhl_df %>% 
  mutate(mean_obs_standardized = mean_obs/max(mean_obs)*100)
summary(lm(mean_obs_standardized~log(-DEPTH), d2_lm_in[d2_lm_in$group == "EPAC",]))
summary(lm(mean_obs_standardized~log(-DEPTH), d2_lm_in[d2_lm_in$group == "TSPIN",]))

ggplot(d2_lm_in, aes(log(-DEPTH), mean_obs_standardized, col = group)) +
  geom_path()
```

# Figure 9

```{r}
small_area_pt <- data.frame(lat = c(40.3, 46.7),
                            lon = c(-126, -123.7)) %>% 
  st_as_sf(coords = c("lon", "lat"), crs = 4326) %>% 
  st_transform(crs = 32610)
small_area_extent <- extent(small_area_pt)

# transform into sf format
d9_epac <- pred_nascXmass_ENSENStopolog %>% 
  select(pred_months, pred_epac) %>% 
  filter(substr(pred_months, 7, 7) %in% c("8")) %>% 
  filter(as.numeric(substr(pred_months, 2, 5)) >= 2018)  %>% 
  mutate(pred_df = map(pred_epac, function(r){
      # turn raster to sf object
      d <- r %>% 
        # crop rasters to smaller area
        crop(., small_area_extent) %>% 
        st_as_stars() %>%
        st_as_sf(as_points = T, crs = 32610) %>% 
        rename(fit = layer)
      # add coordinates to dataframe of predictions
      d[c("x", "y")] <- st_coordinates(d)
      return(d)
    })) %>% 
    mutate(month = month(as.POSIXct(pred_months, format = "X%Y.%m.%d"),
                        label = TRUE, abbr = TRUE, 
                        locale="EN-us"),
           year = year(as.POSIXct(pred_months, format = "X%Y.%m.%d")),
           period = paste(month, year)) %>%  
    dplyr::select(period, month, year, pred_df) %>%
    # arrange and mutate factor levels so that plots show up in the right order by months 
    arrange(year, month) %>% 
    mutate(period = factor(period, levels = unique(period))) %>% 
    unnest(pred_df)

d9_tspin <- pred_nascXmass_ENSENStopolog %>% 
  select(pred_months, pred_tspin) %>% 
  filter(substr(pred_months, 7, 7) %in% c("8")) %>% 
  filter(as.numeric(substr(pred_months, 2, 5)) >= 2018)  %>% 
  mutate(pred_df = map(pred_tspin, function(r){
      # turn raster to sf object
      d <- r %>% 
        # crop rasters to smaller area
        crop(., small_area_extent) %>% 
        st_as_stars() %>%
        st_as_sf(as_points = T, crs = 32610) %>% 
        rename(fit = layer)
      # add coordinates to dataframe of predictions
      d[c("x", "y")] <- st_coordinates(d)
      return(d)
    })) %>% 
    mutate(month = month(as.POSIXct(pred_months, format = "X%Y.%m.%d"),
                        label = TRUE, abbr = TRUE,
                        locale="EN-us"),
           year = year(as.POSIXct(pred_months, format = "X%Y.%m.%d")),
           period = paste(month, year)) %>%  
    dplyr::select(period, month, year, pred_df) %>%
    # arrange and mutate factor levels so that plots show up in the right order by months 
    arrange(year, month) %>% 
    mutate(period = factor(period, levels = unique(period))) %>% 
    unnest(pred_df)

places_onepanel_smallarea <- data.frame(name = c( "Columbia River", "Newport","Cape Blanco", "Cape Mendocino"),
                      lon = c( -124.7, -124.3, -124.5, -124.6),
                      lat = c( 46.35, 44.65, 42.83, 40.445)) %>% 
  st_as_sf(., coords = c("lon", "lat"), crs = 4326) %>% 
  st_transform(crs = 32610) %>% 
  slice(rep(1:n(), each = n_distinct(d9_epac$period))) %>%
  mutate(period = rep(unique(d9_epac$period), times = 4),
         label = ifelse(period != "Aug 2018", NA, name))

# sf version of the dataframe
d9_sf <- st_as_sf(d9_epac, coords = c("x", "y"), crs = 32610)

g9.tspin <- ggplot() +
    geom_tile(data = d9_tspin, aes(x, y, fill = log(fit + 0.1))) +
    scale_fill_viridis_b(na.value = "transparent", 
                         name = expression(atop(italic("T. spinifera"), "-scaled NASC")),
                        breaks = log(c(5, 10, 20, 50, 100, 200)),
                        labels = c(5, 10, 20, 50, 100, 200)) +
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey90", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
    geom_sf(data = states, fill = NA, col = "grey30", size = 0.1) +
    facet_wrap(~period, ncol = n_distinct(d9_tspin$year), dir = "h")

g9.epac <- ggplot() +
    geom_tile(data = d9_epac, aes(x, y, fill = log(fit + 0.1))) +
    scale_fill_viridis_b(na.value = "transparent", 
                        name = expression(atop(italic("E. pacifica"), "-scaled NASC")),
                        breaks = log(c(5, 20, 50, 200, 500, 1000)),
                        labels = c(5, 20, 50, 200, 500, 1000)) +  
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey90", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
    geom_sf(data = states, fill = NA, col = "grey30", size = 0.1) +
    facet_wrap(~period, ncol = n_distinct(d9_epac$year), dir = "h")

g9 <- (g9.epac / g9.tspin) & 
    plot_annotation(tag_level = "a") &
    ggsn::scalebar(d9_sf, dist = 50, dist_unit = "km", location = "bottomleft", 
                   transform = F, anchor = c(x = 265000, y = 4550000), st.size = 2, st.color = "white",
                   st.dist = 0.03, border.size = 0.1, height = 0.01, facet.var = 'period', 
                   facet.lev = 'Aug 2022') &
    geom_sf_text(data = places_onepanel_smallarea , 
                        aes(label = label), nudge_x = -1, size = 2, col = "grey90") &
    coord_sf(xlim = c(extent(small_area_pt)@xmin, extent(small_area_pt)@xmax), 
             ylim = c(extent(small_area_pt)@ymin, extent(small_area_pt)@ymax), expand = F) &
    mon_theme &
    xlab("") &
    ylab("") &
    theme(axis.text.y = element_text(angle = 90, hjust = 0.5),
          axis.text.x = element_text(angle = 40, vjust = 0.48),
          text=element_text(size=8),
          legend.title =element_text(face="bold", size=8),
          legend.key.size = unit(1, "lines"),
          panel.spacing = unit(0.5, "lines"),
          plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
          strip.background = element_rect(color = "black", fill = "white", linewidth = 0.5, linetype = "solid")) &
    guides(fill = guide_colorbar(barwidth = 0.5, barheight = 10))

ggsave(g9, file = "./Outputs/figure9.png", width = 190, height = 230, dpi = 500, units = "mm")
g9
```


# Supplementary material

Correlation between variables in the krill nasc dataset
```{r}
load("../3-NASC_models/Outputs/krill_day_df.RData")

# vector of environmental variable names
env_var <- c("DIS_SHORE", "DEPTH","DIS_CANYON", "SLOPE", "sst", "ssh", "sshsd", "sstsd","eke", "curl", "ild_05", "bbv_200", "chla")
         
# matrix of correlations
M <- krill_day_df %>%
  dplyr::select(all_of(env_var)) %>%
  rename(CANYON = DIS_CANYON, BBV = bbv_200, 
           CURL = curl, ILD = ild_05, SSHSD = sshsd, 
           SSH = ssh,  SSTSD = sstsd, SST = sst, EKE = eke, 
         SHORE = DIS_SHORE, CHLA = chla) %>% 
  cor(method="pearson", use="pairwise.complete.obs")

# correlation plot
png("./Outputs/supmat_correlations_krill_day_df.png", res = 600, units = "mm", width = 160, height = 160)
corrplot::corrplot(M, method = "number", order = "hclust", tl.cex = 1, cl.cex = 1, type = "lower", diag = F, number.cex = 0.9, addCoefasPercent = T)
dev.off()
```

Map of NCC and NH line stations sampled during the time of this study
```{r}
stations <- rbind(biomass_df %>% 
  select(utmx, utmy, Station) %>% 
  mutate(type = "NCC cruises"),
biomass_nhl_df  %>% 
  select(utmx, utmy, Station) %>% 
  distinct(Station, .keep_all = T) %>% 
  mutate(type = "NH Line"))

g <- ggplot() +
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey80", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
    geom_point(data = stations, aes(utmx, utmy, shape = type), size = 1) +
    scale_shape_manual(values = c(3, 1), name = "Stations") +
    ggsn::scalebar(iso_sf_utm, dist = 100, dist_unit = "km", location = "bottomleft", 
                   transform = F, anchor = c(x = 68000, y = 4250000), st.size = 2, 
                   st.dist = 0.02, border.size = 0.1, height = 0.01) +
    geom_sf_text(data = places, 
                        aes(label = name), nudge_x = 5e4, size = 1.5, col = "grey90") +
    geom_sf(data = states, fill = NA, color = "grey90", size = 0.07) +
    geom_sf_text(data = states_name, aes(label = label), col = "white", size = 3) +
    coord_sf(xlim = c(-30592.78, 561873.5), ylim = c(4150571, 5378175), expand = F) +
    scale_size(guide = "none") +
    mon_theme +
    xlab("") +
    ylab("") +
    theme(axis.text.y = element_text(angle = 90, hjust = 0.5),
          #axis.text.x = element_text(angle = 40, vjust = 0.48),
          legend.key.size = unit(0.6, "lines"),
          legend.position = "bottom",
          legend.box="horizontal",
          panel.spacing = unit(0.1, "lines"),
          plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")) &
    guides(fill = guide_colorbar(title.position="top", title.hjust = 0.5))
g
ggsave(g, file = "./Outputs/supmat_NNC and NHLine station.png", width = 80, height = 140, dpi = 500, units = "mm")
```

Map of NASC data by cruise
```{r}
d <- krill_day_df %>% 
  mutate(season = case_when(substr(CruiseID, 5, 6) == "01" ~ "February",
                            substr(CruiseID, 5, 6) == "02" ~ "February",
                            substr(CruiseID, 5, 6) == "04" ~ "May",
                            substr(CruiseID, 5, 6) == "05" ~ "May",
                            substr(CruiseID, 5, 6) == "08" ~ "September",
                            substr(CruiseID, 5, 6) == "10" ~ "September",
                            substr(CruiseID, 5, 6) == "11" ~ "September"),
          year = paste0("20", substr(CruiseID, 3, 4))) %>% 
  select(-geometry)

g <- ggplot() +
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -500, -1000, -1500), ], 
            col = "grey80", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
    geom_tile(data = d, aes(utmx, utmy, fill = log(nasc + 0.01)), width = 5e3, height = 5e3, alpha = 0.8) +
    scale_fill_viridis(na.value = "transparent", # scale_fill_gradient(low = "grey90", high = "grey5"
                         name = "Total Krill NASC",
                        breaks = log(c(0.01, 10, 10000)), 
                        labels = c(0, 10, 10000)) +
    ggsn::scalebar(iso_sf_utm, dist = 100, dist_unit = "km", location = "bottomleft", 
                   transform = F, anchor = c(x = 68000, y = 4250000), st.size = 2, 
                   st.dist = 0.02, border.size = 0.1, height = 0.01) +
    facet_grid(season~year) +
    geom_sf_text(data = places, 
                        aes(label = name), nudge_x = 5e4, size = 1.5, col = "grey90") +
    geom_sf(data = states, fill = NA, color = "grey90", size = 0.07) +
    geom_sf_text(data = states_name, aes(label = label), col = "white", size = 3) +
    coord_sf(xlim = c(-30592.78, 561873.5), ylim = c(4150571, 5378175), expand = F) +
    scale_size(guide = "none") +
    mon_theme +
    xlab("") +
    ylab("") +
    theme(axis.text.y = element_text(angle = 90, hjust = 0.5),
          axis.text.x = element_text(angle = 40, vjust = 0.48),
          legend.key.size = unit(0.6, "lines"),
          legend.position = "bottom",
          legend.box="horizontal",
          panel.spacing = unit(0.1, "lines"),
          plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")) &
    guides(fill = guide_colorbar(title.position="top", title.hjust = 0.5))
g
ggsave(g, file = "./Outputs/supmat_krill_day_df_percruise.png", width = 180, height = 240, dpi = 500, units = "mm")
```


Validation of predicted proportions of Epac and Tspin, using both the NH line and the NCC stations as observed data. This plot is only produced for the selected model in this code. See "Github_all_models" codes for all model comparisons.
```{r}
Fun_evalprop <- function(d, x, y, method, sp){
  if(sp == "Tspin"){colsp <- "#4cd7d0"} else {colsp <- "#e1c340"}
  d$x2 <- unlist(d[x]/d$mass_tot)
  ggpubr::ggscatter(d, x = "x2", y= y, add = "reg.line", color = colsp) +
    ggpubr::stat_cor(label.y = 0.9) +
    ggpubr::stat_regline_equation(label.y = 0.75) +
    mon_theme +
    ggtitle(method) +
    xlab(paste0("Observed proportion of ", sp)) +
    ylab(paste0("Predicted proportion of ", sp)) +
    ylim(0, 1) +
    xlim(0, 1)
}

a6 <- Fun_evalprop(all_biomass_eval_df, 
                   x = "mass_TSPIN", y = "tspin_ENStopolog", method = "ENS - topographic_logdepth", sp = "Tspin")
b6 <- Fun_evalprop(all_biomass_eval_df, 
                   x = "mass_EPAC", y = "epac_ENStopolog", method = "", sp = "Epac")

g <- (a6 + b6) &
  theme(text = element_text(size = 6))
g
ggsave(g, file = "./Outputs/supmat/obs_vs_predicted_proportions.png", width = 120, height = 120, dpi = 500, units = "mm")
```

Predicted proportion of Tspin and Epac biomass over the entire domain
```{r}
# calculate the proportion of EPAC and TSPIN over monthly rasters
pred_propbiomass_ENS <- predyear_crossENSavg_topolog_mass %>% 
  filter(substr(pred_months, 7, 7) %in% c("2", "5", "9")) %>% 
  filter(as.numeric(substr(pred_months, 2, 5)) == 2022) %>% 
  ddply(., ~pred_months, function(d){
    tibble(epac_prop = list(d$meanpred[[1]]/(d$meanpred[[1]] + d$meanpred[[2]])),
    tspin_prop = list(d$meanpred[[2]]/(d$meanpred[[1]] + d$meanpred[[2]])))
})

### TSPIN ################################
d_tspinprop <- pred_propbiomass_ENS %>%
  mutate(meanpred = tspin_prop) %>% 
  mutate(pred_df = map(meanpred, function(r){
      # turn raster to sf object
      d <- r %>% 
        st_as_stars() %>%
        st_as_sf(as_points = T, crs = 32610) %>% 
        rename(fit = layer)
      # add coordinates to dataframe of predictions
      d[c("x", "y")] <- st_coordinates(d)
      return(d)
    })) %>% 
    mutate(month = month(as.POSIXct(pred_months, format = "X%Y.%m.%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us"),
           year = year(as.POSIXct(pred_months, format = "X%Y.%m.%d")),
           period = paste(month, year)) %>%  
    dplyr::select(period, month, year, pred_df) %>%
    # arrange and mutate factor levels so that plots show up in the right order by months 
    arrange(year, month) %>% 
    mutate(period = factor(period, levels = unique(period))) %>% 
    unnest(pred_df)
  
g5a <- ggplot() +
    geom_tile(data = subset(d_tspinprop, period == "Feb 2022"), aes(x, y, fill = fit*100), show.legend = F) +
    geom_sf(data = NAcells, fill = "white", color = "transparent") +
    scale_fill_viridis_b(na.value = "transparent", 
                         n.breaks = 6, limits = c(0, 100)) +  
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -1500), ], 
            col = "grey80", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
    #facet_wrap(~period, ncol = 3, dir = "h") +
    coord_sf(xlim = c(-30592.78, 561873.5), ylim = c(4150571, 5378175), expand = F) +
    ggtitle(expression(italic("T. spinifera")))

### EPAC ################################
d_epacprop <- pred_propbiomass_ENS %>%
  mutate(meanpred = epac_prop) %>% 
  mutate(pred_df = map(meanpred, function(r){
      # turn raster to sf object
      d <- r %>% 
        st_as_stars() %>%
        st_as_sf(as_points = T, crs = 32610) %>% 
        rename(fit = layer)
      # add coordinates to dataframe of predictions
      d[c("x", "y")] <- st_coordinates(d)
      return(d)
    })) %>% 
    mutate(month = month(as.POSIXct(pred_months, format = "X%Y.%m.%d"),
                        label = TRUE, abbr = TRUE, locale="EN-us"),
           year = year(as.POSIXct(pred_months, format = "X%Y.%m.%d")),
           period = paste(month, year)) %>%  
    dplyr::select(period, month, year, pred_df) %>%
    # arrange and mutate factor levels so that plots show up in the right order by months 
    arrange(year, month) %>% 
    mutate(period = factor(period, levels = unique(period))) %>% 
    unnest(pred_df)

g5b <- ggplot() +
    geom_tile(data = subset(d_epacprop, period == "Feb 2022"), aes(x, y, fill = fit*100)) +
    geom_sf(data = NAcells, fill = "white", color = "transparent") +
    scale_fill_viridis_b(na.value = "transparent",
                         name = "Predicted \nProportion (%)",
                         n.breaks = 6, limits = c(0, 100)) +  
    geom_sf(data = iso_sf_utm[iso_sf_utm$g_2020_ %in% c(-200, -1500), ], 
            col = "grey80", linewidth = 0.1) +
    geom_sf(data = coast_sf_utm, col = NA, fill = "grey50") +
    coord_sf(xlim = c(-30592.78, 561873.5), ylim = c(4150571, 5378175), expand = F) +
    ggtitle(expression(italic("E. pacifica")))

### Combine panels ########################
g5 <- g5a + g5b &
  plot_layout(guides = "collect") &
  plot_annotation(tag_levels = "a") &
  mon_theme &
  xlab("") &
  ylab("") &
  theme(text=element_text(face="bold", size=8),
        axis.text.y = element_text(angle = 90, hjust = 0.5, size = 5),
        axis.text.x = element_text(hjust = 0.9, size = 5),
        legend.key.size = unit(1, "lines"),
        legend.position = "bottom",
        panel.spacing = unit(0.5, "lines"),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"))

ggsave(g5, file = "./Outputs/supmat_predicted_proportions_entiredomain.png", width = 110, height = 110, dpi = 300, units = "mm")
g5
```

Predicted abundance of Epac and Tspin along the NH Line as a function of month
```{r}
d1 <- krill_nhl_pred_ENSENStopolog_trend %>% 
  filter(DEPTH < -5) %>%  # because the data point closer to shore is NA
  group_by(group, month, year) %>% 
  summarize(mean_pred_acrossyear = mean(pred, na.rm = T)) %>% 
  group_by(group, month) %>% 
  summarize(mean_pred = mean(mean_pred_acrossyear, na.rm = T),
            sd_pred = sd(mean_pred_acrossyear, na.rm = T),
            se_pred = sd(mean_pred_acrossyear, na.rm = T) / sqrt(n()),
            min_pred = min(mean_pred_acrossyear, na.rm = T),
            max_pred = max(mean_pred_acrossyear, na.rm = T))

g1 <- ggplot(d1, aes(month, mean_pred, color = group, group = group)) +
    geom_ribbon(aes(fill = group, ymin = mean_pred - sd_pred, ymax = mean_pred + sd_pred), 
                color = "transparent", alpha = 0.5) +
    geom_path(alpha = 0.9) +
    scale_y_sqrt("Predicted Species-scaled NASC") +
    scale_color_manual(name = "Species", values = krillsp_pal, 
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
    scale_fill_manual(name = "Species", values = krillsp_pal,
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera")))) +
    mon_theme

g2 <- ggplot() +
    geom_ribbon(data = bymonth_all_nhl_df,
                aes(as.numeric(month), ymin = mean_obs - se_obs, 
                    ymax = mean_obs + se_obs,
                    color = group, fill = group),
                color = "transparent", alpha = 0.5) +
    geom_path(data = bymonth_all_nhl_df,
              aes(as.numeric(month), mean_obs, group = group, 
                  color = group), lty = "21", linewidth = 0.5, alpha = 0.9) +
    geom_col(data = bymonth_18_22_nhl_df, aes(as.numeric(month), mean_obs, color = group, fill = group), position = "dodge", alpha = 0.6) +
    geom_errorbar(data = bymonth_18_22_nhl_df, aes(as.numeric(month), ymin = mean_obs, 
                         ymax = mean_obs + se_obs,
                      color = group),
                      position = position_dodge2(width = 0.2, padding = 0.5)) +
    scale_x_continuous(name = "Month", breaks = c(1:12), labels = unique(bymonth_all_nhl_df$month)) +
    scale_y_sqrt(name = expression(paste("Observed biomass (mg/", m^{3}, ")", sep = "")))+
    scale_color_manual(name = "Species", values = krillsp_pal, 
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera"))), guide = "none") +
    scale_fill_manual(name = "Species", values = krillsp_pal,
             labels = c(expression(italic("E. pacifica")), expression(italic("T. spinifera"))), guide = "none") +
    mon_theme
g <- (g1 / g2) &
  plot_annotation(tag_levels = "a")
ggsave(g, file = "./Outputs/supmat_NHLine_validation_time.png", width = 140, height = 140, dpi = 500, units = "mm")
g
```

Calculate percent increase between seasons and compare between observed and predicted. 
```{r}
####################
### Predicted values
# just the percent increase between Feb and Aug mean predicted values
d1 %>% 
  filter(month %in% c("Feb", "Aug")) %>% 
  select(group, month, mean_pred) %>% 
  pivot_wider(names_from = "month", values_from = "mean_pred") %>% 
  mutate(percent_increase = (Aug - Feb)/Feb *100)

# Rate of increase along linear trend between February and August
d1_lm_in <- d1 %>% 
  mutate(month_continuous = as.numeric(month)) %>% 
  filter(month_continuous <= 8, month_continuous >= 2) %>% 
  mutate(mean_pred_standardized = mean_pred/max(mean_pred)*100)
summary(lm(mean_pred_standardized~month_continuous, d1_lm_in[d1_lm_in$group == "epac",]))
summary(lm(mean_pred_standardized~month_continuous, d1_lm_in[d1_lm_in$group == "tspin",]))
# Rate of decrease along linear trend between August and December
d1_lm_de <- d1 %>% 
  mutate(month_continuous = as.numeric(month)) %>% 
  filter(month_continuous >= 8) %>% 
  mutate(mean_pred_standardized = mean_pred/max(mean_pred)*100)
summary(lm(mean_pred_standardized~month_continuous, d1_lm_de[d1_lm_de$group == "epac",]))
summary(lm(mean_pred_standardized~month_continuous, d1_lm_de[d1_lm_de$group == "tspin",]))
ggplot(d1_lm_in, aes(month_continuous, mean_pred_standardized, col = group)) +
  geom_path()

###################
### Observed values
# Rate of increase along linear trend between February and August
d2_lm_in <- bymonth_all_nhl_df %>% 
  mutate(month_continuous = as.numeric(month)) %>% 
  filter(month_continuous <= 8, month_continuous >= 2) %>% 
  mutate(mean_obs_standardized = mean_obs/max(mean_obs)*100)
summary(lm(mean_obs_standardized~month_continuous, d2_lm_in[d2_lm_in$group == "EPAC",]))
summary(lm(mean_obs_standardized~month_continuous, d2_lm_in[d2_lm_in$group == "TSPIN",]))
# Rate of decrease along linear trend between August and December
d2_lm_de <- bymonth_all_nhl_df %>% 
  mutate(month_continuous = as.numeric(month)) %>% 
  filter(month_continuous >= 8) %>% 
  mutate(mean_obs_standardized = mean_obs/max(mean_obs)*100)
summary(lm(mean_obs_standardized~month_continuous, d2_lm_de[d2_lm_de$group == "EPAC",]))
summary(lm(mean_obs_standardized~month_continuous, d2_lm_de[d2_lm_de$group == "TSPIN",]))

ggplot(d2_lm_in, aes(month_continuous, mean_obs_standardized, col = group)) +
  geom_path()
```
